name: Create a report on Discussion weekly

on:
  schedule:
    - cron: 0 0 * * 1  # At 00:00 (UTC-0) on every monday.

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Scan
        id: report
        run: |
          c=$(git rev-list --all --since '1 week ago' --reverse  | head -n1 || true)
          if [ -n ${c:-} ]; then
            git --no-pager diff --no-color -U0 "$c" HEAD -- '*.md' ':!index.md' |
            grep -v -E '^(index|new file mode|deleted file mode|\-\-\-) ' |
            sed -E -e 's|^diff --git a/(.+) b/.+|```\n\n### \1\n|g' -e 's/^\+\+\+.+/```diff/' |
            tail +2
          fi

      - name: Create a new GitHub Discussion
        uses: abirismyname/create-discussion@v1.x
        if: ${{ steps.rerport.stdout != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          title: "ADoyle's Tools Weekly ($(date +'%Y-%m-%d'))"
          body: |
            What changed in last week:

            ${{steps.rerport.stdout}}
            ```

            Details in https://tools.adoyle.me/

          # https://github.com/marketplace/actions/create-github-discussion#obtaining-the-repository-id-and-category-id
          repository-id: MDEwOlJlcG9zaXRvcnk3Nzc4NzYzOA==
          category-id: DIC_kwDOBKLx9s4CfgjA

      - name: Print discussion url and id
        run: |
          echo discussion-id: ${{steps.create-discussion.outputs.discussion-id}}
          echo discussion-url: ${{steps.create-discussion.outputs.discussion-url}}
